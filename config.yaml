general:
  project_name: "Mi Buñuelito Forecasting"
  random_state: 42
  horizon: 6
  mandatory_history_months: 36
  paths:
    raw: "data/01_raw"
    cleansed: "data/02_cleansed"
    features: "data/03_features"
    processed: "data/04_processed"
    models: "outputs/models"
    reports: "outputs/reports"
    figures: "outputs/figures"
    experiments:
      phase_01: "experiments/phase_01_discovery/artifacts"
      phase_01A: "experiments/phase_01A_financial_audit/artifacts"
      phase_02: "experiments/phase_02_preprocessing/artifacts"

business_rules:
  ventas_diarias:
    # R1: total_unidades = precio_normal + promo_pagadas + promo_bonificadas
    total_units_sum:
      target: "total_unidades_entregadas"
      components: ["unidades_precio_normal", "unidades_promo_pagadas", "unidades_promo_bonificadas"]
    
    # R2: promo_pagadas == promo_bonificadas
    promo_balanced:
      col_pagadas: "unidades_promo_pagadas"
      col_bonificadas: "unidades_promo_bonificadas"
    
    # R3: precio >= costo
    price_viability:
      price: "precio_unitario_full"
      cost: "costo_unitario"
    
    # R4: ingresos = (normal + pagadas) * precio_full
    income_calculation:
      target: "ingresos_totales"
      base_units: ["unidades_precio_normal", "unidades_promo_pagadas"]
      unit_price: "precio_unitario_full"
    
    # R5: costo_total = unidades * costo_unitario
    cost_calculation:
      target: "costo_total"
      total_units: "total_unidades_entregadas"
      unit_cost: "costo_unitario"
    
    # R6: ingresos >= costo_total (Margen Bruto Positivo)
    profitability:
      income: "ingresos_totales"
      cost: "costo_total"
    
    # R7: utilidad = ingresos - costo
    utility_calculation:
      target: "utilidad"
      income: "ingresos_totales"
      cost: "costo_total"

    # Lógica de reconstrucción para el Preprocesador (Alias del R1)
    total_units_recalculation:
      target: "total_unidades_entregadas"
      components: ["unidades_precio_normal", "unidades_promo_pagadas", "unidades_promo_bonificadas"]

  redes_sociales:
    investment_sum:
      target: "inversion_total_diaria"
      components: ["inversion_facebook", "inversion_instagram"]

extractions:
  db_type: "supabase"
  sentinels:
    numeric: [-999, 99999, 9999, -9999]
    categorical: ["None", "NA", "null", "UNDEFINED", "N/A"]
    datetime: ["1900-01-01", "2099-12-31"]
    boolean: []
  tables:
    ventas_diarias:
      table_name: "ventas_diarias"
      date_column: "fecha"
      contract:
        fecha: "datetime"
        total_unidades_entregadas: "integer"
        unidades_precio_normal: "integer"
        unidades_promo_pagadas: "integer"
        unidades_promo_bonificadas: "integer"
        precio_unitario_full: "integer"
        costo_unitario: "float"
        ingresos_totales: "float"
        costo_total: "float"
        utilidad: "float"
    
    macro_economia:
      table_name: "macro_economia"
      date_column: "fecha"
      contract:
        fecha: "datetime"
        ipc_mensual: "float"
        trm_promedio: "float"
        tasa_desempleo: "float"
        costo_insumos_index: "float"
        confianza_consumidor: "float"

    promocion_dia:
      table_name: "promocion_dia"
      date_column: "fecha"
      contract:
        fecha: "datetime"
        es_promo: "integer"

    redes_sociales:
      table_name: "redes_sociales"
      date_column: "fecha"
      contract:
        fecha: "datetime"
        campaign: "text"
        inversion_facebook: "float"
        inversion_instagram: "float"
        inversion_total_diaria: "float"

preprocessing:
  target_variable: "total_unidades_entregadas"
  aggregation_level: "monthly"
  
  # 1 y 2. Limpieza Estructural (Atomicidad y Calidad)
  cleaning:
    # Drop inmediato: Columnas adicionales detectadas en Discovery y las que violan atomicidad
    drop_immediate:
      ventas_diarias: ["ingresos_totales", "costo_total", "utilidad", "id", "created_at"]
      macro_economia: ["id", "created_at"]
      promocion_dia: ["id", "created_at"]
      redes_sociales: ["inversion_total_diaria", "id", "created_at", "campaign"]
    
    # Columnas de soporte: Se usan para el Preprocesado y luego se eliminan (Anti-Laziness/Data Leakage)
    target_build_components: ["unidades_precio_normal", "unidades_promo_pagadas", "unidades_promo_bonificadas"]

  # 3. Blindaje Temporal (Regla de Oro)
  anti_leakage:
    active: true
    mode: "strict_closed_month"

  # 4. Gestión de Duplicados (Filas y Fechas)
  duplicates:
    strategy: "keep_last" # Regla de Oro: Conservar registro más reciente en tiempo de carga

  # 6. Reindexación e Integridad Temporal (Gaps)
  reindexing:
    frequencies:
      ventas_diarias: "D"
      promocion_dia: "D"
      redes_sociales: "D"
      macro_economia: null # Sin reindexación necesaria (frecuencia mensual nativa)

  # 7. Protocolo de Imputación por Dominio
  imputation:
    macro_economia:
      method: "ffill"
      fallback: "bfill"
    
    promocion_dia:
      relevance_year: 2022
      cycles:
        spring: {start: "04-01", end: "05-31"}
        autumn: {start: "09-01", end: "10-31"}
      default_value: 0

    redes_sociales:
      strategy_milestone: "2022-03-17"
      campaign_windows:
        - name: "Ciclo Abr-May"
          start: "03-15"
          end: "05-25"
        - name: "Ciclo Sep-Oct"
          start: "09-15"
          end: "10-25"
      default_investment: 0.0
      default_label: "No ciclo"

    ventas_diarias:
      units:
        method: "ffill"
        fallback: "bfill"
      financials:
        price_col: "precio_unitario_full"
        cost_col: "costo_unitario"
        strategy: "monthly_mode"

eda:
  # 1. Temporal Partitioning (Rule 3.1)
  partitioning:
    test_size: 12
    val_size: 12
    random_state: 42
  
  # 2. Analysis Levels (Rule 3.3)
  analysis_levels: ["month", "quarter", "semester", "year"]
  
  # 3. Time Series Diagnostics (Rule 3.4, 3.5, 3.6)
  time_series:
    decomposition:
      model: "additive"
      period: 12
    stationarity:
      test: "adfuller"
      max_lags: null
      significance_level: 0.05
    autocorrelation:
      max_lags: 24
      alpha: 0.05
  
  # 4. Business Events Validation (Rule 3.7)
  business_events:
    pandemia:
      start: "2020-04-01"
      end: "2021-05-31"
    promociones:
      months: [4, 5, 9, 10]
    novenas:
      start_day: 16
      end_day: 23
      month: 12
    payments:
      days: [15, 30]
      bonus_months: [6, 12]

  # 5. Visualizations & Snapshot Management
  visuals:
    save_figures: true
    history_folder: "history"
    fig_size: [12, 6]
    style: "seaborn-v0_8-whitegrid"
    palette: "viridis"

features:
  projection_method: "recursive_moving_average"
  window_size: 2

modeling:
  strategy: "ForecasterDirect"
  models:
    - "Ridge"
    - "RandomForestRegressor"
    - "LGBMRegressor"
    - "XGBRegressor"
    - "GradientBoostingRegressor"
    - "HistGradientBoostingRegressor"
  backtesting:
    test_size: 12
    val_size: 12
